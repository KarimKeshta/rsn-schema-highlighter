{
    "name": "Relational Schema Notation",
    "scopeName": "source.rsn",
    "fileTypes": ["rsn"],
    "patterns": [
        {"include": "#main"}
    ],
    "repository": {
        "main": {
            "patterns": [
                { "include": "#comments" },

                {"include": "#relationship_source"},
                {"include": "#relationship_target"},
                {"include": "#key_candidate"},
                {"include": "#table_columns"},
                
                {"include": "#tablename"},
                {"include": "#syntax"},
                {"include": "#text"}
            ]
        },

        "comments": {
            "name": "rsn.comment",
            "match": "#.*$"
        },

        "keys_primary": {
            "match": "(_)([A-Za-z0-9]+)(_)",
            "captures": {
                "1": { "name": "rsn.invisible" },
                "2": { "name": "rsn.key.primary" },
                "3": { "name": "rsn.invisible" }
            }
        },

        "relationship_source": {
            "match": "(\\()([A-Za-z0-9_]+)(\\))\\s*(->)",
            "captures": {
                "1": { "name": "rsn.syntax.bracket" },
                "2": { "name": "rsn.relationship.source" },
                "3": { "name": "rsn.syntax.bracket" },
                "4": { "name": "rsn.syntax.relationship" }
            }
        },
        "relationship_target": {
            "match": "\\b([A-Za-z][A-Za-z0-9_]*)\\s*(\\()([A-Za-z0-9_]+)(\\))",
            "captures": {
                "1": { "name": "rsn.tablename" },
                "2": { "name": "rsn.syntax.bracket" },
                "3": { "name": "rsn.relationship.target" },
                "4": { "name": "rsn.syntax.bracket" }
            }
        },

        "key_candidate": {
            "patterns":[
                {
                    "begin": "\\{",
                    "end": "\\}",
                    "beginCaptures": {
                        "0": { "name": "rsn.syntax.bracket" }
                    },
                    "endCaptures": {
                        "0": { "name": "rsn.syntax.bracket" }
                    },
                    "patterns": [
                        {
                            "match": ",",
                            "name": "rsn.syntax.separator"
                        },
                        {
                            "match": "[A-Za-z0-9_]+",
                            "name": "rsn.key.candidate"
                        }
                    ]
                },
                {
                    "match": "(?<=\\})\\s*(->)\\s*(X)",
                    "captures": {
                        "1": { "name": "rsn.syntax.relationship" },
                        "2": { "name": "rsn.syntax.candidate"}
                    }
                }
            ]
        },

        "table_columns": {
            "name": "rsn.definition.columns",
            "begin": "\\s*\\(", 
            "end": "\\)",
            "beginCaptures": {
                "0": {
                    "name": "rsn.syntax.bracket" 
                }
            },
            "endCaptures": {
                "0": { "name": "rsn.syntax.bracket" }
            },
            "patterns": [
                {"include": "#keys_primary"},
                {
                    "name": "rsn.key.foreign",
                    "match": "\\b[A-Za-z0-9_]*(?:ID|Id)\\b"
                },
                {"include": "#text"},
                {"include": "#syntax"}
            ]
        },

        "tablename": {
            "name": "rsn.tablename",
            "match": "\\b[A-Z][A-Za-z0-9_]*\\b(?=\\s*\\()"
        },

        "text": {
            "name": "rsn.text", 
            "match": "\\b[A-Za-z][A-Za-z0-9_]*\\b"
        },

        "syntax": {
            "patterns": [
                {
                    "name": "rsn.syntax.keyword",
                    "match": "\\b(NOT NULL|CHECK)\\b"
                },
                {
                    "name": "rsn.syntax.number",
                    "match": "\\b\\d+\\b"
                },
                {
                    "name": "rsn.syntax.operator",
                    "match": "\\s+(<=|=>|=|<|>)\\s+"
                },
                {
                    "name": "rsn.syntax.separator",
                    "match": "\\s*,\\s*"
                },
                {
                    "name": "rsn.syntax.separator",
                    "match": "\\s*(\\(|\\)|\\{|\\}\\[|\\])\\s*"
                }
            ]
        }
        
    }
}